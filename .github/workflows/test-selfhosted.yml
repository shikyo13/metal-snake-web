name: Run Tests (Self-Hosted)

on:
  push:
    branches: [ main, develop, 'feature/**' ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: [self-hosted, metal-snake-web]
    
    steps:
    - name: Navigate to project directory
      run: |
        cd /home/zero/metal-snake-web
        git config --global --add safe.directory /home/zero/metal-snake-web
        
    - name: Checkout branch
      run: |
        cd /home/zero/metal-snake-web
        git fetch origin
        git checkout -- .
        # For PRs, checkout the PR branch
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-${{ github.event.pull_request.number }}
          git checkout pr-${{ github.event.pull_request.number }}
        else
          git checkout ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}
        fi
        
    - name: Install dependencies
      run: |
        cd /home/zero/metal-snake-web
        npm ci --no-audit --no-fund || npm install --no-audit --no-fund
        
    - name: Run tests
      run: |
        cd /home/zero/metal-snake-web
        npm test || echo "Tests failed with exit code $?"
        
    - name: Return to main branch
      if: always()
      run: |
        cd /home/zero/metal-snake-web
        git checkout main
